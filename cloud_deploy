#!/bin/bash

env_group=0

EXP_SETS=("APDPR" "APDPR_WITH_RANDOM" "PRQL" "DIRECT_WEIGHT_REUSE" "NO_TRANSFER")

#exp_set=APDPR
#exp_set=APDPR_WITH_RANDOM
#exp_set=PRQL
#exp_set=DIRECT_WEIGHT_REUSE
#exp_set=NO_TRANSFER

#MANUAL_FIXING=(6 9 12)

is_in_list() {
    local var="$1"
    shift
    local list=("$@")
    for item in "${list[@]}"; do
        if [ "$var" == "$item" ]; then
            return 0
        fi
    done
    return 1
}

banned_machines=("00000" "18985" "19543" "22965" "17578" "21252" "15473" "19440" "9440" "13725" "10397" "6714")

min() {
    if [ "$1" -lt "$2" ]; then
        echo "$1"
    else
        echo "$2"
    fi
}


tasks_per_instance=10
TASKS_NUMBER=34

max_runner_id=$((TASKS_NUMBER / tasks_per_instance))

echo $max_runner_id
AVG_MAX=2
for ((avg_id=0; avg_id<AVG_MAX; avg_id++)); do
  for exp_set in "${EXP_SETS[@]}"; do
    for ((runner_id=0; runner_id<=max_runner_id; runner_id++)); do
      launched=0
      while [ "$launched" != "1" ]; do
        proposed_machine_id="00000"
        export query_result=$(vastai search offers 'reliability > 0.99 dph < 0.3 cpu_cores_effective > 11 cpu_cores < 39 rented=False cpu_ghz > 3.4' -o 'cpu_cores_effective-' -d)

        row_n=2
        while is_in_list "$proposed_machine_id" "${banned_machines[@]}"; do
          proposed_machine_id=$(echo "$query_result" | awk "NR==$row_n"' {print $19}')

          echo "Price: "
          echo $(echo "$query_result" | awk "NR==$row_n"' {print $10}')
          echo "Id: "
          export I_ID=$(echo "$query_result" | awk "NR==$row_n"' {print $1}')
          echo "$I_ID"

          if is_in_list "$proposed_machine_id" "${banned_machines[@]}"; then
            echo "Catched bad instance incrementing $row_n $proposed_machine_id"
            row_n=$((row_n+1))
          fi
        done





        min_task=$((tasks_per_instance * runner_id))
        max_task=$(((1+runner_id) * tasks_per_instance))

        max_task=$(min "$TASKS_NUMBER" "$max_task")
        #if ! is_in_list "$runner_id" "${MANUAL_FIXING[@]}"; then
        #  echo "Not in emerg list breaking"
        #  break
        #fi

        if [ "$min_task" != "$max_task" ]; then
          echo "Launching instance $runner_id, $avg_id, $min_task, $max_task"
          result=$(vastai create instance "$I_ID" --image pytorch/pytorch:2.2.0-cuda12.1-cudnn8-devel --disk 40 --ssh --direct --env "-e MY_RUNNER_ID=$runner_id -e MIN_TASK=$min_task -e MAX_TASK=$max_task -e ENV_GROUP=$env_group -e EXP_SET=$exp_set -e AVG_ID=$avg_id" --onstart-cmd "env | grep _ >> /etc/environment; wget https://raw.githubusercontent.com/Fotoblysk/avg-transfer-rl/master/cloud_startup.sh; chmod a+x cloud_startup.sh; bash cloud_startup.sh;";)
          echo "$result"
          launched=$(echo $result | grep "'success': True" | wc -l)
          echo "Launched: $launched"
        else
          launched="1"
          echo "Not launching false loop"

        fi
        if [ "$launched" != "1" ]; then
          sleep 300
        fi
        sleep 1
      done
    done
  done
done

echo "Launched"
